services:
bot:
  image: ${DOCKER_IMAGE_BOT}
  container_name: lily_website-bot
  env_file: .env
  restart: always
  depends_on:
    - redis
  networks:
    - lily_website-network

worker:
  image: ${DOCKER_IMAGE_WORKER}
  container_name: lily_website-worker_arq
  env_file: .env
  restart: always
  depends_on:
    - redis
  networks:
    - lily_website-network

redis:
  image: redis:7-alpine
  container_name: lily_website-redis
  command: redis-server --appendonly yes
  volumes:
    - redis-data:/data
  expose:
    - "6379"
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 10s
    timeout: 5s
    retries: 3
  restart: unless-stopped
  networks:
    - lily_website-network

nginx:
  image: ${DOCKER_IMAGE_NGINX}
  container_name: lily_website-nginx
  ports:
    - "80:80"
    - "443:443"
  volumes:
    - ./nginx/nginx-main.conf:/etc/nginx/nginx.conf:ro
    - ./nginx/site.conf:/etc/nginx/conf.d/site.conf:ro
    - uploads:/app/media:ro
  depends_on:
    - backend
  restart: always
  networks:
    - lily_website-network
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

volumes:
  redis-data:
    driver: local

networks:
  lily_website-network:
    driver: bridge
