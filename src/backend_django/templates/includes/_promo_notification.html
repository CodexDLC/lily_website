{% load i18n %}

{% if active_promo %}
<!-- Promo Notification Widget -->
<div id="promoWidget"
     data-promo-id="{{ active_promo.id }}"
     data-delay="{{ active_promo.display_delay|default:5 }}"
     style="display: none;">

    <!-- Floating Button -->
    <button id="promoFloatingButton"
            class="promo-floating-button"
            aria-label="{% trans 'Promotion anzeigen' %}">
        {{ active_promo.button_text }}
    </button>

    <!-- Modal Overlay -->
    <div id="promoModal" class="promo-modal" role="dialog" aria-modal="true">
        <div id="promoModalContent" class="promo-modal-content">
            <button id="promoModalClose" class="promo-modal-close" aria-label="{% trans 'SchlieÃŸen' %}">&times;</button>

            <div id="promoModalHeader" class="promo-modal-header">
                <h2 class="promo-modal-title">{{ active_promo.title }}</h2>
            </div>

            <div class="promo-modal-body">
                {% if active_promo.image %}
                    <img src="{{ active_promo.image.url }}" alt="{{ active_promo.title }}" class="promo-modal-image" draggable="false">
                {% endif %}

                <div class="promo-modal-description">
                    {{ active_promo.description|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Persistent Promo Widget Logic
 * Handles visibility, dragging, and session-based auto-open
 */
(function() {
    const widget = document.getElementById('promoWidget');
    if (!widget) return;

    const promoId = widget.dataset.promoId;
    const delay = parseInt(widget.dataset.delay) * 1000;
    const SESSION_KEY = 'lily_promo_opened_session_' + promoId;

    const btn = document.getElementById('promoFloatingButton');
    const modal = document.getElementById('promoModal');
    const modalContent = document.getElementById('promoModalContent');
    const modalHeader = document.getElementById('promoModalHeader');
    const closeBtn = document.getElementById('promoModalClose');

    const trackAction = (action) => {
        fetch(`/api/v1/promos/${promoId}/track-${action}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        }).catch((error) => console.error(`[PromoWidget] Failed to track ${action}:`, error));
    };

    const openModal = (isAuto = false) => {
        modal.classList.add('active');
        if (!isAuto) trackAction('click');
        // Mark as opened in this session to prevent auto-reopen on refresh
        sessionStorage.setItem(SESSION_KEY, 'true');
    };

    const closeModal = () => {
        modal.classList.remove('active');
    };

    // Dragging Logic
    function initDrag(el, handle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        handle.onmousedown = dragMouseDown;
        handle.ontouchstart = dragMouseDown;

        function dragMouseDown(e) {
            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            pos3 = clientX;
            pos4 = clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
            document.ontouchend = closeDragElement;
            document.ontouchmove = elementDrag;
            el.classList.add('is-dragging');
        }

        function elementDrag(e) {
            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            pos1 = pos3 - clientX;
            pos2 = pos4 - clientY;
            pos3 = clientX;
            pos4 = clientY;
            el.style.top = (el.offsetTop - pos2) + "px";
            el.style.left = (el.offsetLeft - pos1) + "px";
            el.style.right = 'auto';
            el.style.bottom = 'auto';
            el.style.transform = 'none';
            el.style.margin = '0';
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
            document.ontouchend = null;
            document.ontouchmove = null;
            el.classList.remove('is-dragging');
        }
    }

    // Initialize
    window.addEventListener('load', () => {
        // Show widget (button) immediately or with small delay
        setTimeout(() => {
            widget.style.display = 'block';
            trackAction('view');
            initDrag(btn, btn);
            initDrag(modalContent, modalHeader);

            // Auto-open modal only if NOT opened in this session yet
            if (!sessionStorage.getItem(SESSION_KEY)) {
                setTimeout(() => {
                    if (!modal.classList.contains('active')) {
                        openModal(true);
                    }
                }, delay);
            }
        }, 1000);
    });

    btn.addEventListener('click', () => {
        if (!btn.classList.contains('is-dragging')) openModal();
    });

    closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        closeModal();
    });

    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('active')) closeModal(); });
})();
</script>
{% endif %}
