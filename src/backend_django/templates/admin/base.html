{% extends "unfold/layouts/base.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}

<!-- ========================================
     PWA META TAGS
     ======================================== -->

<!-- Theme Color -->
<meta name="theme-color" content="#3b82f6">
<meta name="msapplication-TileColor" content="#3b82f6">
<meta name="msapplication-navbutton-color" content="#3b82f6">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- PWA Capabilities -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="LILY Admin">

<!-- Viewport Optimizations -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json" crossorigin="use-credentials">

<!-- ========================================
     ICONS
     ======================================== -->

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="{% static 'img/favicon/favicon.svg' %}">
<link rel="icon" type="image/png" sizes="96x96" href="{% static 'img/favicon/favicon-96x96.png' %}">
<link rel="shortcut icon" href="{% static 'img/favicon/favicon.ico' %}">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/favicon/apple-touch-icon-180x180.png' %}">

<!-- Android Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="{% static 'img/favicon/icon-192x192.png' %}">
<link rel="icon" type="image/png" sizes="512x512" href="{% static 'img/favicon/icon-512x512.png' %}">

<!-- ========================================
     CUSTOM PWA STYLES
     ======================================== -->

<!-- –ú–æ–±–∏–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
<link rel="stylesheet" href="{% static 'css/admin/pwa-mobile.css' %}">

<!-- ========================================
     SERVICE WORKER REGISTRATION
     ======================================== -->

<script>
// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js', {
            scope: '/'
        })
        .then(registration => {
            console.log('‚úÖ Service Worker registered:', registration.scope);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Service Worker...');

                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        console.log('‚ú® –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞');

                        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                        if (window.showToast) {
                            window.showToast('–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'info');
                        }
                    }
                });
            });
        })
        .catch(err => {
            console.log('‚ùå Service Worker registration failed:', err);
        });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Service Worker
    navigator.serviceWorker.addEventListener('message', event => {
        if (event.data && event.data.type === 'CACHE_CLEARED') {
            console.log('üóëÔ∏è –ö—ç—à –æ—á–∏—â–µ–Ω');
            if (window.showToast) {
                window.showToast('–ö—ç—à –æ—á–∏—â–µ–Ω', 'success');
            }
        }
    });
}

// ========================================
// PWA INSTALL PROMPT
// ========================================

let deferredPrompt;
let installBannerShown = false;

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('üì± Install prompt available');

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∫–∞–∑ –±—Ä–∞—É–∑–µ—Ä–æ–º
    e.preventDefault();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    deferredPrompt = e;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π install banner –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
    if (!installBannerShown) {
        setTimeout(() => {
            showInstallBanner();
        }, 3000); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    }
});

function showInstallBanner() {
    if (installBannerShown || !deferredPrompt) {
        return;
    }

    installBannerShown = true;

    const banner = document.createElement('div');
    banner.id = 'pwa-install-banner';
    banner.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #3b82f6;
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 10000;
        font-size: 14px;
        font-weight: 500;
        max-width: 90%;
        animation: slideUp 0.3s ease;
    `;

    banner.innerHTML = `
        <span style="font-size: 24px;">üì±</span>
        <span style="flex: 1;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ LILY Admin –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</span>
        <button id="pwa-install-btn" style="
            background: white;
            color: #3b82f6;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        ">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="pwa-dismiss-btn" style="
            background: transparent;
            color: white;
            border: none;
            padding: 8px;
            cursor: pointer;
            font-size: 18px;
        ">‚úï</button>
    `;

    document.body.appendChild(banner);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    document.getElementById('pwa-install-btn').addEventListener('click', installPWA);
    document.getElementById('pwa-dismiss-btn').addEventListener('click', dismissInstallBanner);
}

async function installPWA() {
    if (!deferredPrompt) {
        return;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π install prompt
    deferredPrompt.prompt();

    // –ñ–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`Install outcome: ${outcome}`);

    if (outcome === 'accepted') {
        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É');
        if (window.showToast) {
            window.showToast('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        }
    } else {
        console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É');
    }

    // –û—á–∏—â–∞–µ–º deferred prompt
    deferredPrompt = null;

    // –£–±–∏—Ä–∞–µ–º banner
    dismissInstallBanner();
}

function dismissInstallBanner() {
    const banner = document.getElementById('pwa-install-banner');
    if (banner) {
        banner.style.animation = 'slideDown 0.3s ease reverse';
        setTimeout(() => banner.remove(), 300);
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª banner
    try {
        localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    } catch (e) {
        console.error('localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
    }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ banner –Ω–µ–¥–∞–≤–Ω–æ –∑–∞–∫—Ä—ã—Ç
try {
    const dismissed = localStorage.getItem('pwa-install-dismissed');
    if (dismissed) {
        const daysSinceDismissed = (Date.now() - parseInt(dismissed)) / (1000 * 60 * 60 * 24);
        if (daysSinceDismissed < 7) {
            installBannerShown = true; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º banner –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
        }
    }
} catch (e) {
    console.error('localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
window.addEventListener('appinstalled', () => {
    console.log('‚úÖ PWA —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    deferredPrompt = null;

    if (window.showToast) {
        window.showToast('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    // gtag('event', 'pwa_installed');
});

// ========================================
// ANIMATIONS
// ========================================

const style = document.createElement('style');
style.textContent = `
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(100%);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    #pwa-install-btn:hover {
        background: #f0f0f0;
        transform: scale(1.05);
    }

    #pwa-dismiss-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }
`;
document.head.appendChild(style);

</script>

<!-- ========================================
     PWA ENHANCEMENT SCRIPT
     ======================================== -->

<script src="{% static 'js/admin/pwa-enhance.js' %}" defer></script>

{% endblock %}
