{% extends "telegram_app/tma_base.html" %}

{% block title %}
{% if is_archive %}Contacts Archive{% else %}New Requests ({{ tab|title }}){% endif %}
{% endblock %}

{% block extra_head %}
<!-- SEO Protection: Do not index TMA pages -->
<meta name="robots" content="noindex, nofollow">
{% endblock %}

{% block content %}
<div id="contacts-container">
    {% if not contacts %}
    <div class="empty-state">
        <h3>No requests found.</h3>
        <p>You're all caught up!</p>
    </div>
    {% else %}
    {% if is_archive %}
    <h2>Archive</h2>
    <div
        style="background-color: var(--tg-theme-bg-color, #ffffff); border-radius: 8px; overflow: hidden; border: 1px solid var(--tg-theme-hint-color, #eee);">
        {% for contact in contacts %}
        <details class="archive-item">
            <summary style="font-weight: bold; outline: none;">
                {{ contact.client.name|default:"Unknown Client" }} - {{ contact.get_topic_display }}
                <div style="font-size: 12px; color: var(--tg-theme-hint-color); font-weight: normal; margin-top:4px;">
                    {{ contact.created_at|date:"d M Y, H:i" }}
                </div>
            </summary>
            <div style="margin-top: 10px; padding: 10px; background-color: rgba(0,0,0,0.02); border-radius: 4px;">
                <p><strong>Email:</strong> {{ contact.client.email|default:"N/A" }}</p>
                <p><strong>Phone:</strong> {{ contact.client.phone|default:"N/A" }}</p>
                <div class="contact-message">{{ contact.message }}</div>
                <div class="actions" style="margin-top: 10px;">
                    <button class="btn btn-delete" onclick="handleAction('delete', '{{ contact.id }}')">Delete</button>
                </div>
            </div>
        </details>
        {% endfor %}
    </div>
    {% else %}
    <h2 style="margin-bottom: 15px;">New Requests ({{ tab|title }})</h2>
    {% for contact in contacts %}
    <div class="contact-card" id="card-{{ contact.id }}">
        <div class="contact-header">
            <span class="contact-name">{{ contact.client.name|default:"Unknown Client" }}</span>
            <span class="contact-topic">{{ contact.get_topic_display }}</span>
        </div>
        <div class="contact-meta">
            <div>ðŸ“§ {{ contact.client.email|default:"N/A" }}</div>
            <div>ðŸ“± {{ contact.client.phone|default:"N/A" }}</div>
            <div style="margin-top: 4px;">ðŸ•’ {{ contact.created_at|date:"d M Y, H:i" }}</div>
        </div>
        <div class="contact-message">{{ contact.message }}</div>
        <div class="actions">
            {% url 'telegram_app:reply' as reply_url %}
            <a href="{{ reply_url }}?req_id={{ contact.id }}&ts={{ ts }}&sig={{ sig }}" class="btn btn-reply">Reply</a>
            <button class="btn btn-read" onclick="handleAction('read', '{{ contact.id }}')">Read</button>
            <button class="btn btn-delete" onclick="handleAction('delete', '{{ contact.id }}')">Delete</button>
        </div>
    </div>
    {% endfor %}
    {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Security parameters from Django context
    const secParams = {
        req_id: "{{ req_id|escapejs }}",
        ts: "{{ ts|escapejs }}",
        sig: "{{ sig|escapejs }}"
    };

    function handleAction(action, contactId) {
        if (action === 'delete' && !confirm('Are you sure you want to delete this request?')) {
            return;
        }

        // We use Telegram WebApp initData if available, otherwise fallback to URL params
        let initData = "";
        if (window.Telegram && window.Telegram.WebApp) {
            initData = window.Telegram.WebApp.initData;
        }

        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Telegram-Init-Data': initData
            },
            body: JSON.stringify({
                action: action,
                contact_id: contactId,
                req_id: secParams.req_id,
                ts: secParams.ts,
                sig: secParams.sig
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    }

                    // Remove the item from DOM visually
                    const card = document.getElementById('card-' + contactId);
                    if (card) {
                        card.style.opacity = '0.5';
                        setTimeout(() => card.remove(), 300);
                    } else {
                        // For archive layout or if card not found, reload page
                        window.location.reload();
                    }
                } else {
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.showAlert('Error: ' + data.message);
                    } else {
                        alert('Error: ' + data.message);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.showAlert('An error occurred.');
                } else {
                    alert('An error occurred.');
                }
            });
    }

    // Configure main WebApp Button if needed
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.MainButton.hide();
    }
</script>
{% endblock %}
