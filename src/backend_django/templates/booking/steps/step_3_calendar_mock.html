{% load i18n %}
<div class="step-content fade-in">
    <div class="step-header-row">
        <h3 class="step-heading">
            {% trans "Wählen Sie einen Termin" %}
        </h3>
        <button class="btn-back"
                hx-get="{% url 'booking_wizard' %}?step=2&service_id={{ selected_service.id }}"
                hx-target="#wizard-content"
                hx-swap="innerHTML">
            ← {% trans "Zurück" %}
        </button>
    </div>

    <div class="calendar-layout">

        <!-- LEFT: CALENDAR WIDGET -->
        <div class="calendar-widget">
            <div class="calendar-header">
                <!-- Prev Month -->
                <button class="cal-nav-btn"
                        hx-get="{% url 'booking_wizard' %}?step=3&month={{ current_month|add:'-1' }}&year={{ current_year }}&service_id={{ selected_service.id }}&master_id={{ master_id }}"
                        hx-target="#wizard-content"
                        hx-swap="innerHTML">
                    ‹
                </button>

                <span class="cal-month-title">{{ month_label }}</span>

                <!-- Next Month -->
                <button class="cal-nav-btn"
                        hx-get="{% url 'booking_wizard' %}?step=3&month={{ current_month|add:'1' }}&year={{ current_year }}&service_id={{ selected_service.id }}&master_id={{ master_id }}"
                        hx-target="#wizard-content"
                        hx-swap="innerHTML">
                    ›
                </button>
            </div>

            <div class="calendar-weekdays">
                <span>Mo</span><span>Di</span><span>Mi</span><span>Do</span><span>Fr</span><span>Sa</span><span>So</span>
            </div>

            <div class="calendar-days">
                {% for day in calendar_days %}
                    {% if day.status == 'empty' %}
                        <span class="day empty"></span>
                    {% elif day.status == 'disabled' %}
                        <button class="day disabled">{{ day.num }}</button>
                    {% elif day.status == 'holiday' %}
                        <button class="day holiday" title="{{ day.title }}">{{ day.num }}</button>
                    {% else %}
                        <!-- Active Day -->
                        <button class="day {% if day.date == selected_date_obj|date:'Y-m-d' %}active{% endif %}"
                                hx-get="{% url 'booking_wizard' %}?step=3&date={{ day.date }}&service_id={{ selected_service.id }}&master_id={{ master_id }}"
                                hx-target="#wizard-content"
                                hx-swap="innerHTML"
                                onclick="selectDay(this)">
                            {{ day.num }}
                        </button>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Legend -->
            <div class="calendar-legend" style="margin-top: 15px; display: flex; gap: 15px; font-size: 12px; color: var(--color-text-muted);">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 8px; height: 8px; background: var(--color-gold); border-radius: 50%;"></span>
                    <span>{% trans "Ausgewählt" %}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 8px; height: 8px; background: rgba(255,100,100,0.3); border-radius: 50%;"></span>
                    <span>{% trans "Feiertag" %}</span>
                </div>
            </div>
        </div>

        <!-- RIGHT: TIME SLOTS -->
        <div class="time-slots-panel">
            {% if selected_date_obj %}
                <h4 class="slots-title">{% trans "Verfügbare Zeit am" %} {{ selected_date_obj|date:"d.m." }}</h4>

                {% if available_slots %}
                    <div class="slots-grid-compact">
                        {% for slot in available_slots %}
                        <button class="slot-btn"
                                hx-get="{% url 'booking_wizard' %}?step=4&service_id={{ selected_service.id }}&master_id={{ master_id }}&date={{ selected_date_obj|date:'Y-m-d' }}&time={{ slot }}"
                                hx-target="#wizard-content"
                                hx-swap="innerHTML">
                            {{ slot }}
                        </button>
                        {% endfor %}
                    </div>
                {% else %}
                    <div style="text-align: center; color: var(--color-text-muted); padding: 20px;">
                        {% trans "Keine freien Termine an diesem Tag." %}
                    </div>
                {% endif %}
            {% else %}
                <div style="text-align: center; color: var(--color-text-muted); padding: 40px;">
                    {% trans "Bitte wählen Sie ein Datum im Kalender." %}
                </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- Only include OOB updates for HTMX requests -->
{% if request.headers.HX_Request %}
    <!-- Update Sidebar via OOB -->
    {% include "booking/includes/summary_card.html" %}
    <!-- Update Stepper via OOB -->
    {% include "booking/includes/stepper.html" %}
{% endif %}

<script>
    function selectDay(btn) {
        // Remove active class from all days
        document.querySelectorAll('.day').forEach(d => d.classList.remove('active'));
        // Add active class to clicked day
        btn.classList.add('active');
    }
</script>
